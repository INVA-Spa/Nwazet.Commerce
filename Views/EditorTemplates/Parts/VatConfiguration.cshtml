@using Nwazet.Commerce.ViewModels;
@using Nwazet.Commerce.Models;
@using Orchard.ContentManagement;
@using Orchard.Core.Title.Models;
@using System.Collections.Generic;

@model Nwazet.Commerce.ViewModels.VatConfigurationPartViewModel
@functions{
    IContentManager _contentManager;
}
@{
    _contentManager = WorkContext.Resolve<IContentManager>();
}

@helper DisplayTree(TerritoryPart part, IList<VatConfigurationTerritorySummaryViewModel> subitem) {
    <div class="vatHierarchySummaryRow" style="margin-left:15px">
        @{
            decimal rate = 0;
            var territoryVM = subitem.Where(s => s.Item.Id == part.ContentItem.Id).FirstOrDefault();
            if (territoryVM != null) {
                rate = territoryVM.Rate;
            }
        }

        @if (((territoryVM == null && part.Children.Count() > 0) || rate > 0) && subitem.Count() != 0) {
            @Html.ItemEditLink(part.ContentItem.As<TitlePart>().Title, part.ContentItem) @T(" ({0} %)", rate)
            foreach (var child in part.Children) {
                @DisplayTree(child.As<TerritoryPart>(), subitem);
            }
        }
    </div>
}

<fieldset>
    <div>
        @Html.LabelFor(m => m.TaxProductCategory, T("Category").Text, new { @class = "sub" })
        @Html.TextBoxFor(m => m.TaxProductCategory, new { @class = "text text-medium", title = T("Product category") })
        <div>
            @if (Model.IsDefaultCategory) {
                @T("This is the default category.")
                @Html.HiddenFor(m => m.IsDefaultCategory)
            }
            else {
                <span class="checkbox-and-label">
                    @Html.CheckBoxFor(m => m.IsDefaultCategory)
                    @Html.LabelFor(m => m.IsDefaultCategory, T("Set this as the default category: ").Text, new { @class = "forcheckbox" })
                </span>
                <span class="hint">@T("Check to set this category as the default one.")</span>
            }
        </div>
        <span class="hint">@T("The product category this VAT will be applied to. The default category will apply to all products where a category was not specified.")</span>
    </div>
    <div>
        @Html.LabelFor(m => m.Priority, T("Priority").Text, new { @class = "sub" })
        @Html.TextBoxFor(m => m.Priority, new { @class = "text text-small", pattern = "[0-9]", @type = "number" })
        <span class="hint">@T("The priority to apply this tax. The highest priority wins. This makes it possible to create a hierarchy of taxes.")</span>
    </div>
    <div>
        @Html.LabelFor(m => m.DefaultRate, T("Default Rate for territories outside the hierarchy").Text, new { @class = "sub" })
        @Html.TextBoxFor(m => m.DefaultRate, new { @class = "text text-small", @type = "number" })
        <span class="hint">@T("The default percent rate for this VAT that will be applied when the destination for products is not found in any of the hierarchies for territories selected for this VAT configuration.")</span>
    </div>
    <div>
        @if (Model.ItemizedSummary.Any()) {
            @T("This VAT category is configured for the following regions:")

            foreach (var item in Model.ItemizedSummary) {
                <div class="vatConfigurationSummaryTable">
                    <div class="vatHierarchySummaryRow" style="margin-left:15px">
                        @Html.ItemEditLink(item.Name, item.Item) @T(" ({0} %)", item.Rate)

                        @{
                           var territories = _contentManager.Query<TerritoryPart,TerritoryPartRecord>()
                                 .Where(tpr => tpr.Hierarchy.Id == item.Item.Id && tpr.ParentTerritory == null)
                                 .List();
                            foreach (var subitem in territories) {
                                @DisplayTree(subitem.As<TerritoryPart>(), item.SubRegions);
                            }
                        }
                    </div>
                </div>
            }
        }
        else {
            @T("There are no hierarchy configurations for this VAT category.")
        }
    </div>
</fieldset>
