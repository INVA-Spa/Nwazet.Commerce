(function(n){n.widget("mjs.nestedSortable",n.extend({},n.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,isAllowed:function(){return!0}},_create:function(){if(this.element.data("sortable",this.element.data("nestedSortable")),!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check the listType option is set to your actual list type");return n.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){return this.element.removeData("nestedSortable").unbind(".nestedSortable"),n.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(t){var i,u,o,a;for(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(i=this.options,u=!1,this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity?this.scrollParent[0].scrollTop=u=this.scrollParent[0].scrollTop+i.scrollSpeed:t.pageY-this.overflowOffset.top<i.scrollSensitivity&&(this.scrollParent[0].scrollTop=u=this.scrollParent[0].scrollTop-i.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity?this.scrollParent[0].scrollLeft=u=this.scrollParent[0].scrollLeft+i.scrollSpeed:t.pageX-this.overflowOffset.left<i.scrollSensitivity&&(this.scrollParent[0].scrollLeft=u=this.scrollParent[0].scrollLeft-i.scrollSpeed)):(t.pageY-n(document).scrollTop()<i.scrollSensitivity?u=n(document).scrollTop(n(document).scrollTop()-i.scrollSpeed):n(window).height()-(t.pageY-n(document).scrollTop())<i.scrollSensitivity&&(u=n(document).scrollTop(n(document).scrollTop()+i.scrollSpeed)),t.pageX-n(document).scrollLeft()<i.scrollSensitivity?u=n(document).scrollLeft(n(document).scrollLeft()-i.scrollSpeed):n(window).width()-(t.pageX-n(document).scrollLeft())<i.scrollSensitivity&&(u=n(document).scrollLeft(n(document).scrollLeft()+i.scrollSpeed))),u!==!1&&n.ui.ddmanager&&!i.dropBehaviour&&n.ui.ddmanager.prepareOffsets(this,t)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&this.options.axis=="y"||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&this.options.axis=="x"||(this.helper[0].style.top=this.position.top+"px"),o=this.items.length-1;o>=0;o--){var s=this.items[o],f=s.item[0],c=this._intersectsWithPointer(s);if(c&&f!=this.currentItem[0]&&this.placeholder[c==1?"next":"prev"]()[0]!=f&&!n.contains(this.placeholder[0],f)&&(this.options.type=="semi-dynamic"?!n.contains(this.element[0],f):!0)){if(n(f).mouseenter(),this.direction=c==1?"down":"up",this.options.tolerance=="pointer"||this._intersectsWithSides(s))n(f).mouseleave(),this._rearrange(t,s);else break;this._clearEmpty(f);this._trigger("change",t,this._uiHash());break}}var e=this.placeholder[0].parentNode.parentNode&&n(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?n(this.placeholder[0].parentNode.parentNode):null,h=this._getLevel(this.placeholder),l=this._getChildLevels(this.helper),r=this.placeholder[0].previousSibling?n(this.placeholder[0].previousSibling):null;if(r!=null)while(r[0].nodeName.toLowerCase()!="li"||r[0]==this.currentItem[0])if(r[0].previousSibling)r=n(r[0].previousSibling);else{r=null;break}return a=document.createElement(i.listType),this.beyondMaxLevels=0,e!=null&&(i.rtl&&this.positionAbs.left+this.helper.outerWidth()>e.offset().left+e.outerWidth()||!i.rtl&&this.positionAbs.left<e.offset().left)?(e.after(this.placeholder[0]),this._clearEmpty(e[0]),this._trigger("change",t,this._uiHash())):r!=null&&(i.rtl&&this.positionAbs.left+this.helper.outerWidth()<r.offset().left+r.outerWidth()-i.tabSize||!i.rtl&&this.positionAbs.left>r.offset().left+i.tabSize)?(this._isAllowed(r,h,h+l+1),r.children(i.listType).length||r[0].appendChild(a),r.children(i.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",t,this._uiHash())):this._isAllowed(e,h,h+l),this._contactContainers(t),n.ui.ddmanager&&n.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t){var i,r;for(this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?n(this.domPosition.prev).after(this.placeholder):n(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",t,this._uiHash())),i=this.items.length-1;i>=0;i--)r=this.items[i].item[0],this._clearEmpty(r);n.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(t){var i=n.extend({},this.options,t),u=this._getItemsAsjQuery(i&&i.connected),r=[];return n(u).each(function(){var t=(n(i.item||this).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/),u=(n(i.item||this).parent(i.listType).parent(i.items).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/);t&&r.push((i.key||t[1])+"["+(i.key&&i.expression?t[1]:t[2])+"]="+(u?i.key&&i.expression?u[1]:u[2]:i.rootID))}),!r.length&&i.key&&r.push(i.key+"="),r.join("&")},toHierarchy:function(t){function u(t){var f=(n(t).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/),r;if(f)return r={id:f[2]},n(t).children(i.listType).children(i.items).length>0&&(r.children=[],n(t).children(i.listType).children(i.items).each(function(){var n=u(this);r.children.push(n)})),r}var i=n.extend({},this.options,t),f=i.startDepthCount||0,r=[];return n(this.element).children(i.items).each(function(){var n=u(this);r.push(n)}),r},toArray:function(t){function e(t,f,o){var s=o+1,h,c,l;return n(t).children(i.listType).children(i.items).length>0&&(f++,n(t).children(i.listType).children(i.items).each(function(){s=e(n(this),f,s)}),f--),h=n(t).attr(i.attribute||"id").match(i.expression||/(.+)[-=_](.+)/),f===u+1?c=i.rootID:(l=n(t).parent(i.listType).parent(i.items).attr(i.attribute||"id").match(i.expression||/(.+)[-=_](.+)/),c=l[2]),h&&r.push({item_id:h[2],parent_id:c,depth:f,left:o,right:s}),s+1}var i=n.extend({},this.options,t),u=i.startDepthCount||0,r=[],f=2;return r.push({item_id:i.rootID,parent_id:"none",depth:u,left:"1",right:(n(i.items,this.element).length+1)*2}),n(this.element).children(i.items).each(function(){f=e(this,u+1,f)}),r=r.sort(function(n,t){return n.left-t.left})},_clearEmpty:function(t){var i=n(t).children(this.options.listType);i.length&&!i.children().length&&i.remove()},_getLevel:function(n){var i=1,t;if(this.options.listType)for(t=n.closest(this.options.listType);!t.is(".ui-sortable");)i++,t=t.parent().closest(this.options.listType);return i},_getChildLevels:function(t,i){var f=this,u=this.options,r=0;return i=i||0,n(t).children(u.listType).children(u.items).each(function(n,t){r=Math.max(f._getChildLevels(t,i+1),r)}),i?r+1:r},_isAllowed:function(t,i,r){var u=this.options,f=n(this.domPosition.parent).hasClass("ui-sortable")?!0:!1;!u.isAllowed(t,this.placeholder)||t&&t.hasClass(u.disableNesting)||u.protectRoot&&(t==null&&!f||f&&i>1)?(this.placeholder.addClass(u.errorClass),this.beyondMaxLevels=u.maxLevels<r&&u.maxLevels!=0?r-u.maxLevels:1):u.maxLevels<r&&u.maxLevels!=0?(this.placeholder.addClass(u.errorClass),this.beyondMaxLevels=r-u.maxLevels):(this.placeholder.removeClass(u.errorClass),this.beyondMaxLevels=0)}}));n.mjs.nestedSortable.prototype.options=n.extend({},n.ui.sortable.prototype.options,n.mjs.nestedSortable.prototype.options)})(jQuery);